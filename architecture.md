了解しました。
では、**ここまで合意した設計内容を「設計ドキュメント」として一貫した形でまとめます**。
そのまま **社内設計書／README／アーキテクチャ資料**として使える構成にします。

（※ 図や実装コードは入れず、**設計判断が追える文章中心**にします）

---

# MCP対応マイクロサービス・ゲートウェイ設計ドキュメント

## 1. 目的と背景

本ドキュメントは、以下の要件を満たす **マイクロサービス・ゲートウェイ**の設計を記述する。

* マイクロサービスは **Python + Flask** で実装され、**コンテナで実行**される
* サービスのアプリケーションフォルダは **ホストPCのディスクをマウント**
* 設定変更は **マウントされたファイルの編集**により行う
* ゲートウェイは将来的に **MCP（Model Context Protocol）Server** へ移行予定
* 設計段階から **MCPツール／MCPリソース**の概念を明示的に取り入れる

本設計は、**運用の単純性・安全性・将来拡張性**を最優先とする。

---

## 2. 設計方針（確定事項）

### 2.1 基本方針

* **1サービス = 1 MCPツール**
* 設定はすべて **MCPリソース**として扱う
* 実行時に設定を動的に切り替えない
* 並列実行は「設定」ではなく **サービスの系統**で吸収する
* **ソリューションは増やさない**
* **コンテキストは実行のたびに生成される**

---

### 2.2 リソース取得方式

* MCPリソース（設定ファイル）は **content を直接返す方式**を採用する
* CDN や外部ストレージは使用しない
* 将来、大容量リソースが必要になった場合のみ：

  * URL を返し、HTTP GET で取得する方式を **補助的に追加**する

---

## 3. 用語定義

### 3.1 アクタ（Actor）

#### 運用者（Operator）

* ソリューション、MCPツール、MCPリソース、系統を管理する人

#### クライアント（Client）

* ゲートウェイ API を利用して処理を実行する外部プログラム
* 業務アプリ、バッチ、将来の MCP クライアントを含む

---

### 3.2 ソリューション（Solution）

* **システムが提供する実行構成の設計図**
* 以下を静的に定義する：

  * 使用可能な MCPツール
  * 各 MCPツールの並列実行可能な系統数
  * 各系統に対応する MCPリソース（設定）
* 実行中に変更されない

---

### 3.3 コンテキスト（Context）

* ソリューションに基づいて生成される **1回の実行状態**
* 実行のたびに生成され、終了時に破棄される
* 構成情報は持たず、**ソリューションを参照するのみ**

---

### 3.4 MCPツール（MCP Tool）

* MCP におけるツール
* 本設計では **1サービス = 1 MCPツール**
* 実行ロジックを提供する単位

---

### 3.5 系統（Service Line）

* MCPツールを並列実行するための **事前定義された実行枠**
* 各系統は：

  * 固有の系統ID（例：b1, b2, b3）
  * 固有の MCPリソース（設定）
* **系統数はソリューションで静的に定義される**

---

### 3.6 MCPリソース（MCP Resource）

* MCPツールが参照する設定ファイル
* 系統ごとに固定される
* 実行中に切り替えない

---

### 3.7 実行（Invocation）

* 特定の MCPツールの特定系統を使った **1回の処理**
* コンテキストに紐づく

---

### 3.8 妥当性（Validation）

* ソリューション定義が現在のシステム状態と矛盾していないこと
* 以下を確認する：

  * MCPツールの存在
  * 定義された系統の存在
  * MCPリソース（設定）の存在

---

## 4. 全体構造（概念）

```
Solution
 ├─ MCP Tool A
 │   ├─ 系統 a1 ─ MCPリソース
 │   └─ 系統 a2 ─ MCPリソース
 │
 └─ MCP Tool B
     ├─ 系統 b1 ─ MCPリソース
     ├─ 系統 b2 ─ MCPリソース
     └─ 系統 b3 ─ MCPリソース
```

* 並列実行能力は **ソリューションに含まれる**
* コンテキストはこの構成を参照して実行される

---

## 5. ユースケース概要一覧

* UC01 ソリューション一覧を取得する

* UC02 ソリューションの詳細を取得する

* UC03 MCPツール一覧を取得する

* UC04 MCPツールの系統一覧と状態を取得する

* UC05 MCPリソース（設定）を登録・更新する

* UC06 MCPリソース（設定）を取得する

* UC07 ソリューションの妥当性を確認する

* UC08 コンテキストを生成する（実行開始）

* UC09 コンテキストの状態を取得する

* UC10 コンテキストを終了する

---

## 6. 代表的ユースケース（要点）

### 6.1 コンテキスト生成と実行

* クライアントは：

  * ソリューションID
  * MCPツール名
  * 系統ID
    を指定して実行する
* 系統は事前定義された範囲内のみ使用可能
* 空き系統がなければ実行不可

---

### 6.2 並列実行

* 同一 MCPツールでも：

  * 異なる系統を指定すれば同時実行可能
* 設定ファイルの競合は **構造的に発生しない**

---

## 7. MCPリソース取得方式

### 7.1 現行方式（採用）

* MCPリソースは API 応答に **content を直接含めて返す**

```json
{
  "serviceName": "service-b",
  "resourceId": "config",
  "mediaType": "application/json",
  "content": "{ ... }"
}
```

---

### 7.2 将来拡張（非必須）

* 大容量リソースの場合のみ：

  * 取得用 URL を返却
  * クライアントが HTTP GET で取得

この方式は **例外的・補助的**に扱う。

---

## 8. 設計上の重要な判断

* 実行一時設定（ephemeral setting）は導入しない
* 設定は常にファイルに紐づける
* 並列性は **系統**で吸収する
* ソリューションは構成単位として固定
* コンテキストは実行状態のみを表す

---

## 9. 将来の MCP Server 化

本設計は以下の対応関係を持つため、
MCP Server への移行が容易である。

| 本設計     | MCP                |
| ------- | ------------------ |
| ソリューション | Context Definition |
| コンテキスト  | Session            |
| MCPツール  | Tool               |
| 系統      | Tool Instance      |
| MCPリソース | Resource           |
| 実行      | Tool Invocation    |

---

## 10. まとめ

本設計は、

* 運用が単純
* 並列実行が安全
* 実装負荷が低い
* MCP への将来移行に耐える

という特長を持つ。

**現実的かつ長期運用に耐える設計**として、
本ドキュメントを正式設計とする。

---

もし次に進むなら：

* **OpenAPI 最終仕様書**
* **solution.yaml の正式仕様**
* **Flask 実装構成（ディレクトリ・責務）**
* **MCP Server 化チェックリスト**

どれをドキュメント化しますか？
